<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Regression Chart Creator</title>
    <!-- <link rel="stylesheet" type="text/css" href="styles/style.css" /> -->
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.5.0-beta.1/angular.min.js"></script> -->
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.2.19/angular.min.js"></script>
    <script src="app.js"></script>
    <script src="leastSqr.js"></script>
    <style>
      body { font-family: Arial Rounded MT Bold;
             /*background-image: url("img/math7.jpg");*/ }
    </style>
  </head>
  <body>
    <h1>Linear Least Squares Visualizer</h1>
    <div ng-app="app" ng-controller="appCtrl">

      <form name="inputForm" ng-submit="addPoint()" style="margin-bottom: 5px">
        <span>X-value:  </span><input type="number" step="any" name="xVal" ng-model="x_val" />
        <span>Y-value:  </span><input type="number" step="any" name="yVal" ng-model="y_val" />
        <button type="submit">Submit</button>
      </form>

      <div ng-repeat="i in xVals" ng-click="removePoint($index)">
        ( {{i}} , {{yVals[$index]}} )
      </div>

      <form name="regress" ng-submit="calcRegress()">
        <span>type: </span>
        <select name="ftype" ng-model="ftype">
          <option value="0">Polynomial</option>
          <option value="1">Exponential</option>
          <option value="2">Trigonometric</option>
          <option value="3">Logarithmic</option>
        </select>
        <span ng-show="ftype==='0'||ftype==='2'"><span>order: </span><input type="number" ng-model="order" min="0" /></span>
        <button type="submit" ng-click="hasCalc=true">Calculate</button>
      </form>

      <div ng-show="isValid">
        <span ng-show="hasCalc"><strong>y = </strong></span>
        <span ng-repeat="c in solution">
          <span ng-if="saveftype==='0'">
            {{c[0]}}<span ng-if="$index!==0"><strong> x</strong><sup ng-if="$index!==1">{{$index}}</sup></span><span ng-if="solution[$index+1][0]"> + </span>
          </span>
          <span ng-if="saveftype==='2'">
            <!--fix $index ref-->
            {{c[0]}}<span ng-if="$index!==0&&$index%2===1"><strong> sin({{trigOrder[$index]}}x)</strong></span><span ng-if="$index!==0&&$index%2===0"><strong> cos({{trigOrder[$index]}}x)</strong></span><span ng-if="solution[$index+1][0]"> + </span>
          </span>
        </span>
        <span ng-show="hasCalc" ng-if="saveftype==='1'">
          {{solution[0][0]}}<span><strong> e</strong><sup>{{solution[1][0]}} x</sup></span>
        </span>
        <span ng-show="hasCalc" ng-if="saveftype==='3'">
          {{solution[0][0]}}<span><strong> + </strong>{{solution[1][0]}} ln(x)</span>
        </span>
      </div>

      <div>
        <button ng-click="removeCurves()">Clear Curves</button>
      </div>
      <div>
        <button ng-click="removePoints()">Clear Graph</button>
      </div>
      <!--<form ng-show="isValid" ng-submit="calcYVal(arb_x_val)">
        <span>Input x-value: <input type="number" step="any" ng-model="arb_x_val" /></span>
        <buttom type="submit">Find y-value</button>
      </form>-->

      <div>
        <span ng-show="!isValid&&saveftype==='0'">Invalid entry, degree/order of polynomial must be equal to or less than number of data points</span>
        <span ng-show="!isValid&&saveftype==='1'">Invalid entry, y-coordinate of points must be greater than 0 for exponential fit</span>
        <span ng-show="!isValid&&saveftype==='3'">Invalid entry, x-coordinate of points must be greater than 0 for logarithmic fit</span>
      </div>

      <!--remove all points-->

      <canvas id="myCanvas" width="578" height="300" style="margin-top: 10px"></canvas>

      <!--use ui-view-->

      <script ng-if="hasCalc&&isValid">

        function Graph(config) {
          // user defined properties
          this.canvas = document.getElementById(config.canvasId);
          this.minX = config.minX;
          this.minY = config.minY;
          this.maxX = config.maxX;
          this.maxY = config.maxY;
          this.unitsPerTick = config.unitsPerTick;

          // constants
          this.axisColor = '#aaa';
          this.font = '8pt Calibri';
          this.tickSize = 20;

          // relationships
          this.context = this.canvas.getContext('2d');
          this.rangeX = this.maxX - this.minX;
          this.rangeY = this.maxY - this.minY;
          this.unitX = this.canvas.width / this.rangeX;
          this.unitY = this.canvas.height / this.rangeY;
          this.centerY = Math.round(Math.abs(this.minY / this.rangeY) * this.canvas.height);
          this.centerX = Math.round(Math.abs(this.minX / this.rangeX) * this.canvas.width);
          this.iteration = (this.maxX - this.minX) / 1000;
          this.scaleX = this.canvas.width / this.rangeX;
          this.scaleY = this.canvas.height / this.rangeY;

          // draw x and y axis
          this.drawXAxis();
          this.drawYAxis();
        }

        Graph.prototype.drawXAxis = function() {
          var context = this.context;
          context.save();
          context.beginPath();
          context.moveTo(0, this.centerY);
          context.lineTo(this.canvas.width, this.centerY);
          context.strokeStyle = this.axisColor;
          context.lineWidth = 2;
          context.stroke();

          // draw tick marks
          var xPosIncrement = this.unitsPerTick * this.unitX;
          var xPos, unit;
          context.font = this.font;
          context.textAlign = 'center';
          context.textBaseline = 'top';

          // draw left tick marks
          xPos = this.centerX - xPosIncrement;
          unit = -1 * this.unitsPerTick;
          while(xPos > 0) {
            context.moveTo(xPos, this.centerY - this.tickSize / 2);
            context.lineTo(xPos, this.centerY + this.tickSize / 2);
            context.stroke();
            context.fillText(unit, xPos, this.centerY + this.tickSize / 2 + 3);
            unit -= this.unitsPerTick;
            xPos = Math.round(xPos - xPosIncrement);
          }

          // draw right tick marks
          xPos = this.centerX + xPosIncrement;
          unit = this.unitsPerTick;
          while(xPos < this.canvas.width) {
            context.moveTo(xPos, this.centerY - this.tickSize / 2);
            context.lineTo(xPos, this.centerY + this.tickSize / 2);
            context.stroke();
            context.fillText(unit, xPos, this.centerY + this.tickSize / 2 + 3);
            unit += this.unitsPerTick;
            xPos = Math.round(xPos + xPosIncrement);
          }
          context.restore();
        };

        Graph.prototype.drawYAxis = function() {
          var context = this.context;
          context.save();
          context.beginPath();
          context.moveTo(this.centerX, 0);
          context.lineTo(this.centerX, this.canvas.height);
          context.strokeStyle = this.axisColor;
          context.lineWidth = 2;
          context.stroke();

          // draw tick marks
          var yPosIncrement = this.unitsPerTick * this.unitY;
          var yPos, unit;
          context.font = this.font;
          context.textAlign = 'right';
          context.textBaseline = 'middle';

          // draw top tick marks
          yPos = this.centerY - yPosIncrement;
          unit = this.unitsPerTick;
          while(yPos > 0) {
            context.moveTo(this.centerX - this.tickSize / 2, yPos);
            context.lineTo(this.centerX + this.tickSize / 2, yPos);
            context.stroke();
            context.fillText(unit, this.centerX - this.tickSize / 2 - 3, yPos);
            unit += this.unitsPerTick;
            yPos = Math.round(yPos - yPosIncrement);
          }

          // draw bottom tick marks
          yPos = this.centerY + yPosIncrement;
          unit = -1 * this.unitsPerTick;
          while(yPos < this.canvas.height) {
            context.moveTo(this.centerX - this.tickSize / 2, yPos);
            context.lineTo(this.centerX + this.tickSize / 2, yPos);
            context.stroke();
            context.fillText(unit, this.centerX - this.tickSize / 2 - 3, yPos);
            unit -= this.unitsPerTick;
            yPos = Math.round(yPos + yPosIncrement);
          }
          context.restore();
        };

        Graph.prototype.drawEquation = function(equation, color, thickness) {
          var context = this.context;
          context.save();
          context.save();
          this.transformContext();

          context.beginPath();
          context.moveTo(this.minX, equation(this.minX));

          for(var x = this.minX + this.iteration; x <= this.maxX; x += this.iteration) {
            context.lineTo(x, equation(x));
          }

          context.restore();
          context.lineJoin = 'round';
          context.lineWidth = thickness;
          context.strokeStyle = color;
          context.stroke();
          context.restore();
        };

        Graph.prototype.transformContext = function() {
          var context = this.context;

          // move context to center of canvas
          this.context.translate(this.centerX, this.centerY);

          /*
           * stretch grid to fit the canvas window, and
           * invert the y scale so that that increments
           * as you move upwards
           */
          context.scale(this.scaleX, -this.scaleY);
        };

        Graph.prototype.drawPoint = function(cX, cY) {
          var context = this.context;
          var radius = (this.unitX + this.unitY)/20;
          cX = this.unitX * cX + 5 * this.unitX;
          if (cY === 0){
            cY = this.unitY * cY + 5 * this.unitY + 10 * this.unitY;
          } else {
            cY = 5 * this.unitY + (10 - cY) * this.unitY;
          }
          context.beginPath();
          context.arc(cX, cY, radius, 0, 2 * Math.PI, false);
          context.fillStyle = 'black';
          context.fill();
          context.stroke();
        };

        Graph.prototype.redrawGraph = function(){
          var canvas = document.getElementById("myCanvas");
          var context = canvas.getContext("2d");
          context.clearRect(0,0,canvas.width,canvas.height);

          this.minX = -5;
          this.minY = -15;
          this.maxX = 15;
          this.maxY = 5;
          this.unitsPerTick = 1;

          this.drawXAxis();
          this.drawYAxis();
        };

        var myGraph = new Graph({
          canvasId: 'myCanvas',
          minX: -5,
          minY: -15,
          maxX: 15,
          maxY: 5,
          unitsPerTick: 1
        });

        myGraph.drawEquation(function(x) {
          window.onload = function(){
            if(angular.element(document.querySelector('[ng-controller="appCtrl"]')).scope().hasCalc){
              var solution = angular.element(document.querySelector('[ng-controller="appCtrl"]')).scope().solution;
              console.log("solution "+JSON.stringify(solution));
              var eq;
              for(var i=0;i<solution.length;i++){
                eq += solution[i][0] * Math.pow(x,i);
              }
              return eq;
            }
          }
        }, 'green', 3);

        // myGraph.drawEquation(function(x) {
        //   return x * x;
        // }, 'blue', 3);

        // myGraph.drawEquation(function(x) {
        //   return 1 * x;
        // }, 'red', 3);

      </script>

    </div>
  </body>
</html>
